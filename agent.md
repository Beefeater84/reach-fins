## Agent instructions

- All comments in the code should be in English.
- All tasks located in `tasks` folder.

## Tasks

- [Setup project](tasks/setup.md)
- [Connect to Supabase](tasks/connect-to-supabase.md)

## Technology stack

- React 19
- TypeScript
- Tailwind CSS
- Vite
- React Router v6
- Superbase
- OpenAI API
- AWS Amplify (hosting for static files, SSR disabled)

## Project description

In DB we have list of Finns who earn more then 100k per year.
User can ask questions about these Finns. And our application should answer these questions.

We will use OpenAI API to understand user question and extract relevant data from DB.

## Environment Variables

The project uses the following environment variables that must be configured in your `.env` file:

### Supabase Configuration

- **`VITE_SUPABASE_PROJECT_URL`** - URL path to the Supabase API with API version

  Example: `https://mxomgyawonkcchdwglkn.supabase.co/rest/v1`

  This URL is used to access Supabase's PostgREST API. The API follows REST conventions and provides automatic CRUD operations for database tables. For detailed API documentation, see [PostgREST documentation](https://docs.postgrest.org/en/latest/index.html).

- **`VITE_SUPABASE_ANON_KEY`** - Public anonymous key for Supabase authentication

  This is a public key that can be safely used on the client-side for authentication and authorization with Supabase services. It allows access to public data and enables user authentication flows.

### Other Configuration Variables

- **`VITE_SUPABASE_URL`** - Local Supabase instance URL (used for development)
- **`VITE_API_KEY`** - API authentication key for Supabase
- **`VITE_API_PASS`** - API password for additional authentication
- **`VITE_DB_PASSWORD`** - Database connection password
- **`OPENAI_API_KEY`** - OpenAI API key for AI-powered question processing

### Setup Instructions

1. Copy `.env.example` to `.env` (if template exists)
2. Fill in all required values
3. Ensure all `VITE_*` variables are properly prefixed for Vite environment variable handling

## API Response Format

This response format is used for the initial user query processing. The main handler for user requests is implemented in `app\entities\reach-finns\api\get-reach-finns.ts`.

### Query Processing Architecture

The application uses a two-tier approach for handling user queries:

1. **Initial Query Processing** (`get-reach-finns.ts`):
   - Processes user's natural language question through OpenAI API
   - Returns structured response with `generatedQuery` in PostgREST format
   - Goes through Lambda function for AI processing

2. **Pagination Requests** (`get-pagination-query.ts`):
   - Uses the `generatedQuery` from initial response for subsequent pages
   - Makes direct requests to Supabase PostgREST API
   - Handles pagination by adding `offset` parameter to the query
   - Faster response time since it bypasses AI processing

The OpenAI API integration returns structured responses in the following format:

```json
{
  "message": "Query executed successfully",
  "originalQuery": "User's original question in natural language",
  "generatedQuery": "Generated SQL/PostgREST query based on user input",
  "results": ["Array of matching Finnish records from database"],
  "count": 20,
  "totalCount": 200,
  "pagination": {
    "currentPageSize": 20,
    "totalCount": 200,
    "startIndex": 0,
    "endIndex": 19,
    "hasNextPage": true,
    "hasPreviousPage": false
  },
  "status": "completed"
}
```

### Response Fields Description

- **`message`** - Status message indicating query execution result
- **`originalQuery`** - The user's original question in natural language
- **`generatedQuery`** - SQL/PostgREST query generated by OpenAI based on user input
- **`results`** - Array containing matching Finnish records from the database
- **`count`** - Number of results returned in current page
- **`totalCount`** - Total number of matching records available
- **`pagination`** - Object containing pagination metadata:
  - `currentPageSize` - Number of items per page
  - `totalCount` - Total available records
  - `startIndex` - Index of first item in current page (0-based)
  - `endIndex` - Index of last item in current page (0-based)
  - `hasNextPage` - Boolean indicating if more pages are available
  - `hasPreviousPage` - Boolean indicating if previous pages exist
- **`status`** - Query execution status (`completed`, `error`, `processing`)

This response format ensures consistent data structure for frontend components and enables proper pagination handling.

## Typography Guidelines

We use **@tailwindcss/typography** plugin for consistent content styling:

### Setup

- Typography plugin is configured in `app/application/styles/tailwind.css`
- Custom text sizes are defined in `@theme` section with line-height values

### Usage Pattern

For content-heavy components, use the `prose` classes:

```tsx
<div className="prose prose-lg prose-slate dark:prose-invert max-w-none">
  {/* Content with automatic typography styling */}
</div>
```

### Available Classes

- `prose` - base typography styles
- `prose-lg` - larger text size
- `prose-slate` - gray color scheme
- `dark:prose-invert` - dark theme support
- `max-w-none` - removes default width constraints

### Custom Text Sizes Available

- `text-xs` (0.75rem) to `text-9xl` (8rem)
- Each size includes corresponding line-height
- Custom fonts: `font-sans` (Inter) and `font-display` (Lexend)

**Best Practice**: Use `prose` classes for rich content (articles, descriptions) and individual text size classes for UI components.

## Links and docs:

- [Supabase](https://supabase.com/docs)
- [OpenAI API](https://platform.openai.com/docs/api-reference)
- [React Router v6](https://reactrouter.com/en/main)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [Tailwind Typography](https://tailwindcss.com/docs/typography-plugin)
- [Vite](https://vitejs.dev/guide/)
- [Supabase local development](https://supabase.com/docs/guides/local-development)

## Process for Creating New Tasks

The following process is used for creating new development tasks:

### 1. Task Preparation

1. **Use the template**: Take the template from `doc/ai_task_template.md` as the foundation for task planning
2. **Fill in key sections**:
   - **Problem**: Clearly describe the problem that needs to be solved
   - **Current task**: Formulate the specific task and expected outcome
   - **Solution paths**: Propose technical solution options considering the current architecture

### 2. Planning and Coordination

1. **Analyze current state**: Analyze existing code and architecture
2. **Define technical solution**: Choose the optimal approach considering:
   - Existing technical stack
   - Feature-Sliced Design architecture
   - Performance and security requirements
3. **Create implementation plan**: Break down the task into phases with specification of files to be modified

### 3. Confirmation Before Implementation

⚠️ **IMPORTANT**: Before starting code changes, it is necessary to:

1. **Present the plan to the user** with detailed description of:
   - Which files will be modified
   - What functionality will be added/changed
   - Possible risks and side effects
2. **Wait for confirmation** from the user
3. **Make adjustments** to the plan if necessary

### 4. Implementation Rules

- **Prohibited** to modify code files before receiving user confirmation
- **Must** use existing technical stack
- **Must** test changes before committing

### 5. Language Requirements

⚠️ **IMPORTANT**: All development artifacts must be in English:

- **All tasks and documentation** must be written in English
- **All code comments** must be in English
- **All commit messages** must be in English
- **All variable names, function names, and identifiers** must be in English
- **All error messages and user-facing text** must be in English (unless localization is specifically required)

## Database Schema

### Table: `people`

This table contains financial and demographic information about individuals, likely from Finnish tax records.

| Column             | Type             | Nullable | Description                                       |
| ------------------ | ---------------- | -------- | ------------------------------------------------- |
| `id`               | bigint           | NOT NULL | Primary key, auto-generated identity              |
| `name`             | text             | YES      | Full name of the person                           |
| `living_province`  | text             | YES      | Province/region where the person lives            |
| `earnings_total`   | bigint           | YES      | Total earnings/income in currency units           |
| `earned_income`    | bigint           | YES      | Income from employment/work                       |
| `capital_income`   | bigint           | YES      | Income from investments/capital gains             |
| `tax_rate`         | double precision | YES      | Tax rate applied (as decimal, e.g., 0.25 for 25%) |
| `income_after_tax` | bigint           | YES      | Net income after tax deductions                   |
| `remaining_tax`    | text             | YES      | Additional tax information or status              |
| `refunds`          | bigint           | YES      | Tax refunds received                              |
| `birth_year`       | bigint           | YES      | Year of birth                                     |
| `rank`             | bigint           | YES      | Overall ranking (likely by income/earnings)       |
| `province_rank`    | bigint           | YES      | Ranking within the specific province              |
